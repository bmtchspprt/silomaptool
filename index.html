<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Site Map & SIM Assessment</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 10px; max-width: 900px; margin: auto; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        #map { height: 400px; width: 100%; border-radius: 10px; margin: 15px 0; border: 2px solid #333; }
        .btn { padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-blue { background: #007bff; width: 100%; font-size: 1.1rem; }
        .btn-green { background: #28a745; }
        .sim-active { border: 3px solid #e67e22 !important; }
        .status { color: #666; font-size: 0.9rem; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="card">
    <h2>Site Assessment & SIM Tool</h2>
    
    <div class="grid">
        <input type="text" id="name" placeholder="Name">
        <input type="text" id="company" placeholder="Company">
        <input type="email" id="email" placeholder="Your Email" style="grid-column: span 2;">
        <div style="grid-column: span 2; display: flex; gap: 5px;">
            <input type="text" id="address" placeholder="Enter Site Address">
            <button class="btn btn-green" onclick="findAddress()">Locate</button>
        </div>
    </div>

    <div id="map"></div>
    
    <div id="sim-display" style="background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-family: monospace;">
        SIM DATA: <span id="coords">Click map to drop SIM points</span>
    </div>

    <textarea id="notes" rows="3" placeholder="Field Notes..."></textarea>
    <button class="btn btn-blue" onclick="sendToMail()">Generate Apple Mail Report</button>
    <div id="status" class="status"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    // Initialize Satellite Map
    const map = L.map('map').setView([37.09, -95.71], 4);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri', crossOrigin: true
    }).addTo(map);

    let marker;
    let simPoints = [];

    async function findAddress() {
        const addr = document.getElementById('address').value;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
        const data = await res.json();
        if (data[0]) {
            const pos = [data[0].lat, data[0].lon];
            map.setView(pos, 19);
            if (marker) marker.setLatLng(pos);
            else marker = L.marker(pos).addTo(map);
        }
    }

    // SIM Tool: Track coordinates and distances
    map.on('click', (e) => {
        const { lat, lng } = e.latlng;
        simPoints.push(e.latlng);
        L.circle([lat, lng], { radius: 1, color: 'orange' }).addTo(map);
        document.getElementById('coords').innerText = `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;
    });

    async function sendToMail() {
        const status = document.getElementById('status');
        status.innerText = "Processing Screenshot...";
        
        const canvas = await html2canvas(document.getElementById('map'), { useCORS: true });
        const imgData = canvas.toDataURL('image/png');

        const payload = {
            name: document.getElementById('name').value,
            company: document.getElementById('company').value,
            address: document.getElementById('address').value,
            notes: document.getElementById('notes').value,
            image: imgData
        };

        const response = await fetch('http://localhost:3000/report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) status.innerText = "Apple Mail Opened!";
        else status.innerText = "Error: Is the Node server running?";
    }
</script>
</body>
</html>
